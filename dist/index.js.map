{"version":3,"file":"index.js","sources":["../src/index.js"],"sourcesContent":["import path from 'path';\nimport loaderUtils from 'loader-utils';\n\nimport NodeTargetPlugin from 'webpack/lib/node/NodeTargetPlugin';\nimport SingleEntryPlugin from 'webpack/lib/SingleEntryPlugin';\nimport WebWorkerTemplatePlugin from 'webpack/lib/webworker/WebWorkerTemplatePlugin';\n\nexport default function loader() {}\n\nconst CACHE = {};\n\nloader.pitch = function(request) {\n    this.cacheable(false);\n\n    const options = loaderUtils.getOptions(this) || {};\n\n    const babelLoaderOptions = options && options.babelLoaderOptions ? options.babelLoaderOptions : null;\n    const workerCompilationPlugins = options && options.plugins && options.plugins.length ? options.plugins: null;\n    const importScripts = options && options.importScripts && options.importScripts.length ? options.importScripts: null;\n\n    const cb = this.async();\n\n    const filename = loaderUtils.interpolateName(this, `${options.name || '[hash]'}.worker.js`, {\n        context: options.context || this.rootContext || this.options.context,\n        regExp: options.regExp\n    });\n\n    const worker = {};\n\n    worker.options = {\n        filename,\n        chunkFilename: `[id].${filename}`,\n        namedChunkFilename: null\n    };\n\n    worker.compiler = this._compilation.createChildCompiler('worker', worker.options, workerCompilationPlugins);\n\n    worker.compiler.apply(new WebWorkerTemplatePlugin(worker.options));\n\n    if (this.target!=='webworker' && this.target!=='web') {\n        worker.compiler.apply(new NodeTargetPlugin());\n    }\n\n    const entry = `!!${babelLoaderOptions ? 'babel-loader?' + JSON.stringify(babelLoaderOptions) + '!': ''}${path.resolve(__dirname, 'rpc-worker-loader.js')}!${request}`;\n\n    worker.compiler.apply(new SingleEntryPlugin(this.context, entry, 'main'));\n\n    const subCache = `subcache ${__dirname} ${request}`;\n\n    worker.compiler.plugin('compilation', (compilation, data) => {\n        if (compilation.cache) {\n            if (!compilation.cache[subCache]) compilation.cache[subCache] = {};\n\n            compilation.cache = compilation.cache[subCache];\n        }\n\n        data.normalModuleFactory.plugin('parser', (parser, options) => {\n            parser.plugin('export declaration', expr => {\n                let decl = expr.declaration || expr,\n                    { compilation, current } = parser.state,\n                    entry = compilation.entries[0].resource;\n\n                // only process entry exports\n                if (current.resource!==entry) return;\n\n                let exports = compilation.__workerizeExports || (compilation.__workerizeExports = {});\n\n                if (decl.id) {\n                    exports[decl.id.name] = true;\n                }\n                else if (decl.declarations) {\n                    for (let i=0; i<decl.declarations.length; i++) {\n                        exports[decl.declarations[i].id.name] = true;\n                    }\n                }\n                else {\n                    console.warn('[workerize] unknown export declaration: ', expr);\n                }\n            });\n        });\n    });\n\n    worker.compiler.runAsChild((err, entries, compilation) => {\n        if (err) return cb(err);\n\n        if (entries[0]) {\n            worker.file = entries[0].files[0];\n\n            let contents = compilation.assets[worker.file].source();\n            let exports = Object.keys(CACHE[worker.file] = compilation.__workerizeExports || CACHE[worker.file] || {});\n\n            // console.log('Workerized exports: ', exports.join(', '));\n\n            if (importScripts){\n                contents = `try{self.importScripts(self.location.origin + '${'/' + importScripts.join(',')}')} catch(e){console.log(e)};\\n` + contents;\n            }\n\n            if (options.inline) {\n                worker.url = `URL.createObjectURL(new Blob([${JSON.stringify(contents)}]))`;\n            }\n            else {\n                worker.url = `__webpack_public_path__ + ${JSON.stringify(worker.file)}`;\n            }\n\n            if (options.fallback === false) {\n                delete this._compilation.assets[worker.file];\n            }\n\n            return cb(null, `\n\t\t\t\tvar addMethods = require(${loaderUtils.stringifyRequest(this, path.resolve(__dirname, 'rpc-wrapper.js'))})\n\t\t\t\tvar methods = ${JSON.stringify(exports)}\n\t\t\t\tmodule.exports = function() {\n\t\t\t\t\tvar w = new Worker(${worker.url}, { name: ${JSON.stringify(filename)} })\n\t\t\t\t\taddMethods(w, methods)\n\t\t\t\t\t${ options.ready ? 'w.ready = new Promise(function(r) { w.addEventListener(\"ready\", function(){ r(w) }) })' : '' }\n\t\t\t\t\treturn w\n\t\t\t\t}\n\t\t\t`);\n        }\n\n        return cb(null, null);\n    });\n};\n"],"names":["const","let","this"],"mappings":"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"}